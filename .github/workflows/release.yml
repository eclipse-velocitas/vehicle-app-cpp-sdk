# Copyright (c) 2022 Robert Bosch GmbH
#
# This program and the accompanying materials are made available under the
# terms of the Apache License, Version 2.0 which is available at
# https://www.apache.org/licenses/LICENSE-2.0.
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
# WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
# License for the specific language governing permissions and limitations
# under the License.
#
# SPDX-License-Identifier: Apache-2.0

name: SDK - Release workflow

concurrency:
  group: sdk-release-${{ github.ref }}
  cancel-in-progress: true

on:
  release:
    types: [published, edited]

jobs:
  release-package:
    name: Generate package binaries
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.REPO_SECRET }}
          submodules: true

      - name: Set tags output
        id: vars
        run: echo ::set-output name=tag::${GITHUB_REF#refs/*/}

      - name: install prerequisites
        run: |
          sudo apt-get install -y ninja-build clang-tidy
          pip3 install conan

      - name: Set up GCC
        uses: egor-tensin/setup-gcc@v1
        with:
          version: 10

      - name: build conan package
        run: conan create .

      - name: Zip the package
        run: tar -czf ${GITHUB_REF#refs/*/}.tar.gz -C /home/runner/.conan/data/vehicle-app-sdk/0.1/_/_/package/*/ .

      - name: Upload artifacts
        uses: actions/upload-artifact@v2
        with:
          name: release
          path: ./*.tar.gz

      - name: Upload assets
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: ./*.tar.gz
